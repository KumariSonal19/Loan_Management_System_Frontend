<div class="page-container">
  <div class="page-header">
    <h1>Pending Loan Applications</h1>
    <p>Review and process new loan applications</p>
  </div>

  @if (isLoading) {
    <app-loader message="Loading pending loans..."></app-loader>
  } @else {
    @if (pendingLoans.length > 0) {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Loan ID</th>
              <th>Amount Requested</th>
              <th>Tenure</th>
              <th>Annual Income</th>
              <th>Employment Score</th>
              <th>Applied Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (loan of pendingLoans; track loan.id!) {
              <tr>
                <td><strong>#{{ loan.id }}</strong></td>
                <td>{{ loan.loanAmount | currencyFormat }}</td>
                <td>{{ loan.tenure }} months</td>
                <td>{{ loan.annualIncome | currencyFormat }}</td>
                <td>
                  @if (loan.employmentScore) {
                    <span>{{ loan.employmentScore }}/100</span>
                  } @else {
                    <span>N/A</span>
                  }
                </td>
                <td>{{ loan.appliedDate! | dateFormat }}</td>
                <td>
                  <span class="badge" 
                        [class.status-applied]="loan.status === 'APPLIED'"
                        [class.status-review]="loan.status === 'UNDER_REVIEW'">
                    {{ loan.status === 'APPLIED' ? 'New' : 'Under Review' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-sm btn-outline" (click)="viewDetails(loan.id!)">
                      View
                    </button>
                    <button class="btn btn-sm btn-primary" (click)="openReviewModal(loan)">
                      Review
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    } @else {
      <div class="no-data">
        <p>No pending loan applications</p>
      </div>
    }
  }

  @if (showReviewModal) {
    <div class="modal-overlay" (click)="closeReviewModal()">
      <div class="modal-dialog" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Review Loan Application #{{ selectedLoan?.id }}</h2>
          <button class="close-btn" (click)="closeReviewModal()">×</button>
        </div>

        <div class="loan-summary">
          <div class="summary-item">
            <span class="label">Requested Amount:</span>
            <span class="value">{{ selectedLoan?.loanAmount ?? 0 | currencyFormat }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Tenure:</span>
            <span class="value">{{ selectedLoan?.tenure }} months</span>
          </div>
          <div class="summary-item">
            <span class="label">Annual Income:</span>
            <span class="value">{{ selectedLoan?.annualIncome ?? 0 | currencyFormat }}</span>
          </div>
          @if (selectedLoan?.employmentScore) {
            <div class="summary-item">
              <span class="label">Employment Score:</span>
              <span class="value">{{ selectedLoan?.employmentScore }}/100</span>
            </div>
          }
        </div>

        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          <div class="form-group">
            <label for="status">Decision *</label>
            <select id="status" formControlName="status" class="form-control">
              <option value="">-- Select Decision --</option>
              <option value="UNDER_REVIEW">Move to Under Review</option>
              <option value="APPROVED">Approve Loan</option>
              <option value="REJECTED">Reject Loan</option>
            </select>
            @if (hasError('status', 'required')) {
              <span class="error-message">Decision is required</span>
            }
          </div>

          @if (reviewForm.get('status')?.value === 'APPROVED') {
            <div class="approval-fields">
              <div class="form-group">
                <label for="approvedAmount">Approved Amount (₹) *</label>
                <input
                  type="number"
                  id="approvedAmount"
                  formControlName="approvedAmount"
                  class="form-control"
                  [class.error]="hasError('approvedAmount', 'required')"
                  placeholder="Enter approved amount"
                />
                @if (hasError('approvedAmount', 'required')) {
                  <span class="error-message">Approved amount is required</span>
                }
                @if (hasError('approvedAmount', 'min')) {
                  <span class="error-message">Minimum amount is ₹10,000</span>
                }
              </div>

              <div class="form-group">
                <label for="interestRate">Interest Rate (%) *</label>
                <input
                  type="number"
                  step="0.01"
                  id="interestRate"
                  formControlName="interestRate"
                  class="form-control"
                  [class.error]="hasError('interestRate', 'required')"
                  placeholder="e.g., 10.5"
                />
                @if (hasError('interestRate', 'required')) {
                  <span class="error-message">Interest rate is required</span>
                }
                @if (hasError('interestRate', 'min')) {
                  <span class="error-message">Minimum rate is 1%</span>
                }
                @if (hasError('interestRate', 'max')) {
                  <span class="error-message">Maximum rate is 50%</span>
                }
              </div>
            </div>
          }

          <div class="form-group">
            <label for="remarks">Remarks *</label>
            <textarea
              id="remarks"
              formControlName="remarks"
              class="form-control"
              rows="4"
              placeholder="Enter your review comments..."
              [class.error]="hasError('remarks', 'required')"
            ></textarea>
            @if (hasError('remarks', 'required')) {
              <span class="error-message">Remarks are required</span>
            }
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="closeReviewModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Submit Review
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>